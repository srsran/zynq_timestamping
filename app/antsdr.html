

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Application Note: End-to-End 4G testing with AntSDR &mdash; zynq_timestamping  1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Application Note: Tx-Rx testing with ADALM-PLUTO" href="plutosdr.html" />
    <link rel="prev" title="ZCU111 project build" href="../bitstream/zcu111_project.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffffff" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Main page</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">SRS Zynq timestamping solution</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FPGA projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../bitstream/overview.html">Overview of the Zynq timestamping solution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bitstream/plutosdr_project.html">ADALM-PLUTO project build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bitstream/antsdr_project.html">MicroPhase AntSDR project build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bitstream/zcu102_project.html">ZCU102 project build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bitstream/zcu111_project.html">ZCU111 project build</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application notes</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Application Note: End-to-End 4G testing with AntSDR</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hardware-and-software-requirements">Hardware and Software Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-and-configuring-srsran">Building and configuring srsRAN</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#srsenb">srsENB</a></li>
<li class="toctree-l3"><a class="reference internal" href="#srsue">srsUE</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#running">Running</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#network-namespace-creation">Network Namespace Creation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-epc">Running the EPC</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-enodeb">Running the eNodeB</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-ue">Running the UE</a></li>
<li class="toctree-l3"><a class="reference internal" href="#traffic-generation">Traffic Generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#namespace-deletion">Namespace Deletion</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#limitations">Limitations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="plutosdr.html">Application Note: Tx-Rx testing with ADALM-PLUTO</a></li>
<li class="toctree-l1"><a class="reference internal" href="zcu.html">Application Note: Petalinux build, software cross-compilation and Tx-Rx testing with the ZCU102 and ZCU111 platforms</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">RTL modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../rtl_module/adc_dma_packet_controller.html">ADC DMA packet controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rtl_module/adc_dmac_xlength_sniffer.html">ADC DMAC xlength sniffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rtl_module/adc_fifo_timestamp_enabler.html">ADC FIFO timestamp enabler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rtl_module/adc_timestamp_enabler_packetizer.html">ADC timestamp enabler packetizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rtl_module/dac_dmac_xlength_sniffer.html">DAC DMAC xlength sniffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rtl_module/dac_fifo_timestamp_enabler.html">DAC FIFO timestamp enabler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rtl_module/dma_depack_channels.html">DMA depack channels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rtl_module/timestamp_unit_lclk_count.html">Timestamp unit lclk count</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rtl_module/rfdc_adc_data_decim_and_depack.html">RFDC ADC data interp and pack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rtl_module/rfdc_dac_data_interp_and_pack.html">RFDC dac data decim and depack</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">zynq_timestamping </a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Application Note: End-to-End 4G testing with AntSDR</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/srsran/zynq_timestamping/blob/main/doc/app/antsdr.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="application-note-end-to-end-4g-testing-with-antsdr">
<span id="antsdr"></span><h1>Application Note: End-to-End 4G testing with AntSDR<a class="headerlink" href="#application-note-end-to-end-4g-testing-with-antsdr" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<img alt="System" src="../_images/app_note_antsdr.png" />
</div>
<div class="section" id="hardware-and-software-requirements">
<h2>Hardware and Software Requirements<a class="headerlink" href="#hardware-and-software-requirements" title="Permalink to this headline">¶</a></h2>
<p>For this application note, the following hardware and software will be used:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Dell XPS13 with Ubuntu 20.04.4</p></li>
<li><p>USRP B200 mini</p></li>
<li><p>AntSDR with custom SRS bitstream</p></li>
<li><p>srsRAN</p></li>
<li><p>SRS Zynq timestamping</p></li>
<li><p>Analog Devices libiio and libad9361 software libraries</p></li>
</ol>
</div></blockquote>
</div>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<p>1. You need to generate the custom SRS timestamp bitstream and to load it in the board (see the
<a class="reference internal" href="../bitstream/antsdr_project.html#antsdr-project"><span class="std std-ref">MicroPhase AntSDR project build</span></a>
section for more details).</p>
<ol class="arabic simple" start="2">
<li><p>Install srsRAN dependencies:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>build-essential<span class="w"> </span>cmake<span class="w"> </span>libfftw3-dev<span class="w"> </span>libmbedtls-dev<span class="w"> </span>libboost-program-options-dev<span class="w"> </span>libconfig++-dev<span class="w"> </span>libsctp-dev
</pre></div>
</div>
<p>3. Install the libiio software library (see Analog Devices
<a class="reference external" href="https://wiki.analog.com/resources/tools-software/linux-software/libiio">libiio wiki</a>
and
<a class="reference external" href="https://github.com/analogdevicesinc/libad9361-iio">libad9361-iio repository</a>
for the full instructions).</p>
</div>
<div class="section" id="building-and-configuring-srsran">
<h2>Building and configuring srsRAN<a class="headerlink" href="#building-and-configuring-srsran" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>Set the board IP, the frequency offset and the RX gain for the UE:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">BOARD_IP</span><span class="o">=</span><span class="s2">&quot;192.168.1.10&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">FREQ_OFFSET</span><span class="o">=</span><span class="s2">&quot;0&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">RX_GAIN</span><span class="o">=</span><span class="s2">&quot;50&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">TIME_ADV_NSAMPLES</span><span class="o">=</span><span class="s2">&quot;0&quot;</span>
</pre></div>
</div>
<p><strong>NOTE (1):</strong> we advise starting with <em>FREQ_OFFSET=”0”</em> and <em>TIME_ADV_NSAMPLES=”0”</em> and then manually
adjusting them as required by the specific utilized hardware setup, in order to minimize the CFO and
ensure a good time-alignment between eNB and UE.</p>
<p><strong>NOTE (2):</strong> the AntSDR bitsream has been built by default to implement an internal buffering stage in
the timestamped DAC path supporting storage of up to 10x 8000 sample-packets coming from the CPU - that is,
according to values set for the <em>CONFIG.PARAM_BUFFER_LENGTH</em> and <em>CONFIG.PARAM_MAX_DMA_PACKET_LENGTH</em>
parameters of the
<a class="reference external" href="https://github.com/srsran/zynq_timestamping/tree/main/ip/ADI_timestamping/RTL_code/dac_fifo_timestamp_enabler.vhd">dac_fifo_timestamp_enabler</a>
block in the board’s
<a class="reference external" href="https://github.com/srsran/zynq_timestamping/tree/main/projects/antsdr/src/bd/system.tcl#L340">system.tcl</a>
script, which would theoretically enable storing 10 ms worth of signal up to 5 MHz BW (i.e., 7680 samples
per subframe). Nevertheless, by default the
<a class="reference external" href="https://github.com/srsran/zynq_timestamping/tree/main/sw/lib/src/phy/rf/rf_iio_imp.c#L36">RF IIO driver</a>
uses DMA packets of 1920 samples - that is, 1 ms (one subframe) worth of signal for 1.4 MHz BW.</p>
<p>2. Execute the initialization script. It will compile the srsRAN stack as well as the RF drivers
utilized by the Zynq timestamping solution. Moreover, it will also modify the default srsenb and
srsue configuration with the parameter values defined above.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/srsran/zynq_timestamping.git<span class="w"> </span>--recursive
<span class="nb">cd</span><span class="w"> </span>app
./prepare.sh
</pre></div>
</div>
<div class="section" id="srsenb">
<h3>srsENB<a class="headerlink" href="#srsenb" title="Permalink to this headline">¶</a></h3>
<p>Check the following parameters in bin_app/srsue/enb.conf.</p>
<p>In enb.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">enb</span><span class="p">]</span>
<span class="n">n_prb</span> <span class="o">=</span> <span class="mi">6</span>
<span class="p">[</span><span class="n">rf</span><span class="p">]</span>
<span class="n">rx_gain</span> <span class="o">=</span> <span class="mi">80</span>
<span class="p">[</span><span class="n">expert</span><span class="p">]</span>
<span class="n">max_prach_offset_us</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">lte_sample_rates</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
</div>
<p>In sib.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prach_freq_offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">zero_correlation_zone_config</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="section" id="srsue">
<h3>srsUE<a class="headerlink" href="#srsue" title="Permalink to this headline">¶</a></h3>
<p>The following parameters have been configured with <cite>prepare.sh</cite> script: freq_offset, rx_gain,
time_adv_nsamples, continuous_tx, ndevice_args, nof_phy_threads and lte_sample_rates.</p>
</div>
</div>
<div class="section" id="running">
<h2>Running<a class="headerlink" href="#running" title="Permalink to this headline">¶</a></h2>
<div class="section" id="network-namespace-creation">
<h3>Network Namespace Creation<a class="headerlink" href="#network-namespace-creation" title="Permalink to this headline">¶</a></h3>
<p>Let’s start with creating a new network namespace called “ue1” for the (first) UE:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ip</span> <span class="n">netns</span> <span class="n">add</span> <span class="n">ue1</span>
</pre></div>
</div>
<p>To verify the new “ue1” netns exists, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ip</span> <span class="n">netns</span> <span class="nb">list</span>
</pre></div>
</div>
</div>
<div class="section" id="running-the-epc">
<h3>Running the EPC<a class="headerlink" href="#running-the-epc" title="Permalink to this headline">¶</a></h3>
<p>Now let’s start the EPC. This will create a TUN device in the default network namespace and
therefore needs root permissions.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">./</span><span class="n">bin_app</span><span class="o">/</span><span class="n">srsepc</span><span class="p">;</span> <span class="n">sudo</span> <span class="o">./</span><span class="n">srsepc</span> <span class="o">./</span><span class="n">epc</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
</div>
<div class="section" id="running-the-enodeb">
<h3>Running the eNodeB<a class="headerlink" href="#running-the-enodeb" title="Permalink to this headline">¶</a></h3>
<p>Let’s now launch the eNodeB. In our test setup, the eNodeB uses an USRP B200 mini wit serial number
<cite>318A396</cite> (replace the serial as required by your setup):
.. code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">./</span><span class="n">bin_app</span><span class="o">/</span><span class="n">srsenb</span><span class="p">;</span> <span class="n">sudo</span> <span class="n">nice</span> <span class="o">-</span><span class="mi">20</span> <span class="o">./</span><span class="n">srsenb</span> <span class="o">./</span><span class="n">enb</span><span class="o">.</span><span class="n">conf</span> <span class="o">--</span><span class="n">rf</span><span class="o">.</span><span class="n">device_name</span><span class="o">=</span><span class="n">uhd</span> <span class="o">--</span><span class="n">rf</span><span class="o">.</span><span class="n">device_args</span><span class="o">=</span><span class="n">serial</span><span class="o">=</span><span class="mi">318</span><span class="n">A396</span>
</pre></div>
</div>
</div>
<div class="section" id="running-the-ue">
<h3>Running the UE<a class="headerlink" href="#running-the-ue" title="Permalink to this headline">¶</a></h3>
<p>Lastly we can launch the UE, again with root permissions to create the TUN device.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">LD_LIBRARY_PATH</span><span class="o">=./</span><span class="n">bin_app</span> <span class="n">nice</span> <span class="o">-</span><span class="mi">20</span> <span class="o">./</span><span class="n">bin_app</span><span class="o">/</span><span class="n">srsue</span><span class="o">/</span><span class="n">srsue</span> <span class="o">./</span><span class="n">bin_app</span><span class="o">/</span><span class="n">srsue</span><span class="o">/</span><span class="n">ue</span><span class="o">.</span><span class="n">conf</span> <span class="o">--</span><span class="n">gw</span><span class="o">.</span><span class="n">netns</span><span class="o">=</span><span class="n">ue1</span>
</pre></div>
</div>
<p>The last command should start the UE and attach it to the core network.
The UE will be assigned an IP address in the configured range (e.g. 172.16.0.2).</p>
</div>
<div class="section" id="traffic-generation">
<h3>Traffic Generation<a class="headerlink" href="#traffic-generation" title="Permalink to this headline">¶</a></h3>
<p>To exchange traffic in the downlink direction, i.e. from the the EPC, just run ping or iperf as
usual on the command line, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ping</span> <span class="mf">172.16.0.2</span>
</pre></div>
</div>
<p>In order to generate traffic in the uplink direction it is important to run the ping command
in the UE’s network namespace.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ip</span> <span class="n">netns</span> <span class="n">exec</span> <span class="n">ue1</span> <span class="n">ping</span> <span class="mf">172.16.0.1</span>
</pre></div>
</div>
</div>
<div class="section" id="namespace-deletion">
<h3>Namespace Deletion<a class="headerlink" href="#namespace-deletion" title="Permalink to this headline">¶</a></h3>
<p>After finishing, make sure to remove the netns again.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ip</span> <span class="n">netns</span> <span class="n">delete</span> <span class="n">ue1</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Make sure antsdr IP is correctly configured in ue.conf, for example:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">rf</span><span class="p">]</span>
<span class="n">device_name</span> <span class="o">=</span> <span class="n">iio</span>
<span class="n">device_args</span> <span class="o">=</span> <span class="n">n_prb</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">context</span><span class="o">=</span><span class="n">ip</span><span class="p">:</span><span class="mf">10.12.1.201</span>
</pre></div>
</div>
</div>
<div class="section" id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Number of PRB is limited to 6.</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="plutosdr.html" class="btn btn-neutral float-right" title="Application Note: Tx-Rx testing with ADALM-PLUTO" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../bitstream/zcu111_project.html" class="btn btn-neutral float-left" title="ZCU111 project build" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright Software Radio Systems.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-140380699-2', 'auto');
    
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>